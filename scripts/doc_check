#!/bin/bash

# doc_check
# Checks documentation status and reminds about updates
# Usage: doc_check [--strict]

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

STRICT=false
if [ "$1" = "--strict" ]; then
    STRICT=true
fi

info() {
    echo -e "${YELLOW}$1${NC}"
}

success() {
    echo -e "${GREEN}$1${NC}"
}

warn() {
    echo -e "${YELLOW}âš  $1${NC}"
}

error() {
    echo -e "${RED}âœ— $1${NC}"
}

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd -P)"
CHANGELOG="$REPO_ROOT/CHANGELOG.md"
AI_CONTEXT="$REPO_ROOT/docs/project/ai-context.md"
RUNBOOK="$REPO_ROOT/docs/project/runbook.md"

echo ""
info "ðŸ“š Documentation Status Check"
info "=============================="
echo ""

ISSUES=0

# Check CHANGELOG
if [ -f "$CHANGELOG" ]; then
    if grep -q "## Unreleased" "$CHANGELOG"; then
        UNRELEASED_COUNT=$(sed -n '/## Unreleased/,/^## [0-9]/p' "$CHANGELOG" | grep -c "^-" || echo "0")
        if [ "$UNRELEASED_COUNT" -gt 0 ]; then
            success "âœ“ CHANGELOG.md has $UNRELEASED_COUNT unreleased entries"
        else
            warn "CHANGELOG.md 'Unreleased' section is empty"
            info "  Run: doc_update_changelog <category> \"description\""
            ISSUES=$((ISSUES + 1))
        fi
    else
        error "CHANGELOG.md missing 'Unreleased' section"
        ISSUES=$((ISSUES + 1))
    fi
else
    error "CHANGELOG.md not found"
    ISSUES=$((ISSUES + 1))
fi

# Check for recent commits without changelog entries
if git rev-parse --git-dir > /dev/null 2>&1; then
    RECENT_COMMITS=$(git log --oneline --since="7 days ago" --grep="^[^Revert]" 2>/dev/null | wc -l | tr -d ' ')
    if [ "$RECENT_COMMITS" -gt 0 ]; then
        info "  ($RECENT_COMMITS commits in last 7 days - consider adding changelog entries)"
    fi
fi

# Check ADRs
ADR_DIR="$REPO_ROOT/docs/project/decisions"
ADR_COUNT=0
PROPOSED_COUNT=0
ACCEPTED_COUNT=0

if [ -d "$ADR_DIR" ]; then
    ADR_COUNT=$(find "$ADR_DIR" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    if [ "$ADR_COUNT" -gt 0 ]; then
        PROPOSED_COUNT=$(grep -l "Status" "$ADR_DIR"/*.md 2>/dev/null | xargs grep -l "Proposed" 2>/dev/null | wc -l | tr -d ' ' || echo "0")
        ACCEPTED_COUNT=$(grep -l "Status" "$ADR_DIR"/*.md 2>/dev/null | xargs grep -l "Accepted" 2>/dev/null | wc -l | tr -d ' ' || echo "0")
        success "âœ“ Found $ADR_COUNT ADRs ($ACCEPTED_COUNT Accepted, $PROPOSED_COUNT Proposed)"
    else
        warn "No ADRs found in docs/project/decisions/"
    fi
else
    warn "docs/project/decisions/ directory not found"
fi

# Check for proposed ADRs
if [ "$PROPOSED_COUNT" -gt 0 ]; then
    info "  Consider finalizing proposed ADRs (change status to 'Accepted')"
fi

# Check key documentation files
for file in "$AI_CONTEXT" "$RUNBOOK"; do
    if [ -f "$file" ]; then
        success "âœ“ $(basename "$file") exists"
    else
        error "$(basename "$file") not found"
        ISSUES=$((ISSUES + 1))
    fi
done

# Check for large changes that might need ADRs
if git rev-parse --git-dir > /dev/null 2>&1; then
    RECENT_FILES=$(git diff --name-only HEAD~5 2>/dev/null || echo "")
    if echo "$RECENT_FILES" | grep -qE "(apps/|infrastructure/|scripts/)"; then
        info ""
        info "ðŸ’¡ Tip: Recent code changes detected. Consider:"
        info "  - Adding changelog entry: doc_update_changelog <category> \"description\""
        info "  - Creating ADR if architectural: doc_new_adr \"decision-title\""
    fi
fi

echo ""
if [ "$ISSUES" -eq 0 ]; then
    success "âœ“ Documentation looks good!"
else
    warn "$ISSUES issue(s) found. Review documentation before release."
    if [ "$STRICT" = true ]; then
        exit 1
    fi
fi

echo ""
