#!/bin/bash

# doc_new_adr
# Creates a new Architecture Decision Record (ADR) template
# Usage: doc_new_adr <decision-title>
# Example: doc_new_adr "use-docker-for-deployment"

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}$1${NC}"
}

info() {
    echo -e "${YELLOW}$1${NC}"
}

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd -P)"
DOCS_DIR="$REPO_ROOT/docs/project/decisions"

# Check if title provided
if [ $# -eq 0 ]; then
    error "Usage: doc_new_adr <decision-title>"
    echo "Example: doc_new_adr \"use-docker-for-deployment\""
    exit 1
fi

TITLE="$1"
# Convert title to filename format (lowercase, spaces/dots to hyphens)
FILENAME=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')

# Find next ADR number
LAST_NUM=0
if [ -d "$DOCS_DIR" ]; then
    for file in "$DOCS_DIR"/*.md; do
        if [ -f "$file" ]; then
            BASENAME=$(basename "$file")
            NUM=$(echo "$BASENAME" | grep -oE '^[0-9]+' || echo "0")
            # Force base-10 interpretation to avoid octal issues
            NUM=$((10#$NUM))
            if [ "$NUM" -gt "$LAST_NUM" ]; then
                LAST_NUM=$NUM
            fi
        fi
    done
fi

NEXT_NUM=$(printf "%04d" $((LAST_NUM + 1)))
FILENAME="$NEXT_NUM-$FILENAME.md"
FILEPATH="$DOCS_DIR/$FILENAME"

# Create decisions directory if it doesn't exist
mkdir -p "$DOCS_DIR"

# Check if file already exists
if [ -f "$FILEPATH" ]; then
    error "ADR file already exists: $FILEPATH"
fi

# Create ADR template
cat > "$FILEPATH" << EOF
# $NEXT_NUM - $(echo "$TITLE" | sed 's/-/ /g' | sed 's/\b\w/\u&/g')

## Status
Proposed

## Context
What problem are we solving? What constraints matter?

## Decision
What did we decide?

## Alternatives considered
- Option A: pros/cons
- Option B: pros/cons

## Consequences
What becomes easier/harder? What risks remain?

## Links
PRs, issues, docs, chats (if any)
EOF

success "Created ADR: $FILENAME"
info "Location: $FILEPATH"
echo ""
info "Edit the file to fill in the details, then change Status to 'Accepted' when finalized."
