#!/bin/bash

# doc_release
# Moves unreleased changelog entries to a new version
# Usage: doc_release <version> [date]
# Example: doc_release 0.4.0
#          doc_release 0.4.0 2026-01-20

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}$1${NC}"
}

info() {
    echo -e "${YELLOW}$1${NC}"
}

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd -P)"
CHANGELOG="$REPO_ROOT/CHANGELOG.md"

# Check arguments
if [ $# -eq 0 ]; then
    error "Usage: doc_release <version> [date]"
    echo ""
    echo "Examples:"
    echo "  doc_release 0.4.0"
    echo "  doc_release 0.4.0 2026-01-20"
    exit 1
fi

VERSION="$1"
DATE="${2:-$(date +%Y-%m-%d)}"

# Validate version format (basic check)
if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
    error "Invalid version format. Expected: X.Y.Z (e.g., 0.4.0)"
fi

# Check if changelog exists
if [ ! -f "$CHANGELOG" ]; then
    error "CHANGELOG.md not found at: $CHANGELOG"
fi

# Check if unreleased section has content
if ! grep -q "## Unreleased" "$CHANGELOG"; then
    error "CHANGELOG.md doesn't have an 'Unreleased' section"
fi

# Extract unreleased content (between ## Unreleased and next ## version)
UNRELEASED_CONTENT=$(sed -n '/## Unreleased/,/^## [0-9]/p' "$CHANGELOG" | tail -n +2 | head -n -1)
if [ -z "$UNRELEASED_CONTENT" ] || [ "$(echo "$UNRELEASED_CONTENT" | grep -c "^###" || echo "0")" -eq 0 ]; then
    error "No unreleased entries found. Add entries to 'Unreleased' section first."
fi

# Create temporary file
TEMP_FILE=$(mktemp)
trap "rm -f $TEMP_FILE" EXIT

# Read changelog and replace Unreleased section
FOUND_UNRELEASED=false
UNRELEASED_STARTED=false

while IFS= read -r line; do
    if echo "$line" | grep -q "## Unreleased"; then
        FOUND_UNRELEASED=true
        # Write Unreleased header (empty)
        echo "## Unreleased" >> "$TEMP_FILE"
        echo "" >> "$TEMP_FILE"
        echo "- (Keep short; move to a release when you tag)" >> "$TEMP_FILE"
        echo "" >> "$TEMP_FILE"
        # Write new version header
        echo "## $VERSION - $DATE" >> "$TEMP_FILE"
        UNRELEASED_STARTED=true
        continue
    fi
    
    if [ "$FOUND_UNRELEASED" = true ] && [ "$UNRELEASED_STARTED" = true ]; then
        # Check if we hit the next release section
        if echo "$line" | grep -qE "^## [0-9]"; then
            echo "" >> "$TEMP_FILE"
            echo "$line" >> "$TEMP_FILE"
            FOUND_UNRELEASED=false
            UNRELEASED_STARTED=false
            continue
        fi
        # Copy content from unreleased section
        echo "$line" >> "$TEMP_FILE"
        continue
    fi
    
    if [ "$FOUND_UNRELEASED" = true ] && [ "$UNRELEASED_STARTED" = false ]; then
        # We're past the unreleased section, skip until next release
        if echo "$line" | grep -qE "^## [0-9]"; then
            echo "" >> "$TEMP_FILE"
            echo "$line" >> "$TEMP_FILE"
            FOUND_UNRELEASED=false
            continue
        fi
        continue
    fi
    
    echo "$line" >> "$TEMP_FILE"
    
done < "$CHANGELOG"

# Replace changelog
mv "$TEMP_FILE" "$CHANGELOG"

success "Created release $VERSION in CHANGELOG.md"
info "  Date: $DATE"
info ""
info "Next steps:"
info "  1. Review and edit the new release section if needed"
info "  2. Commit the changelog: git add CHANGELOG.md && git commit -m \"chore: release $VERSION\""
info "  3. Tag the release: git tag -a v$VERSION -m \"Release $VERSION\""
