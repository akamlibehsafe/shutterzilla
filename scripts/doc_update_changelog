#!/bin/bash

# doc_update_changelog
# Helper script to add entries to CHANGELOG.md
# Usage: doc_update_changelog <category> <description>
#        doc_update_changelog "Added" "New feature description"
#        doc_update_changelog "Fixed" "Bug fix description"
#        doc_update_changelog "Changed" "Behavior change description"
#        doc_update_changelog "Breaking" "Breaking change description"

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}$1${NC}"
}

info() {
    echo -e "${YELLOW}$1${NC}"
}

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd -P)"
CHANGELOG="$REPO_ROOT/CHANGELOG.md"

# Check arguments
if [ $# -lt 2 ]; then
    error "Usage: doc_update_changelog <category> <description>"
    echo ""
    echo "Categories: Added, Changed, Fixed, Breaking"
    echo ""
    echo "Examples:"
    echo "  doc_update_changelog Added \"New feature description\""
    echo "  doc_update_changelog Fixed \"Bug fix description\""
    exit 1
fi

CATEGORY="$1"
shift
DESCRIPTION="$*"

# Validate category
case "$CATEGORY" in
    Added|Changed|Fixed|Breaking)
        ;;
    *)
        error "Invalid category: $CATEGORY"
        echo "Valid categories: Added, Changed, Fixed, Breaking"
        exit 1
        ;;
esac

# Check if changelog exists
if [ ! -f "$CHANGELOG" ]; then
    error "CHANGELOG.md not found at: $CHANGELOG"
fi

# Find "## Unreleased" section
if ! grep -q "## Unreleased" "$CHANGELOG"; then
    error "CHANGELOG.md doesn't have an 'Unreleased' section"
fi

# Create temporary file
TEMP_FILE=$(mktemp)
trap "rm -f $TEMP_FILE" EXIT

# Read changelog and insert entry
IN_UNRELEASED=false
CATEGORY_SECTION=false
ADDED=false

while IFS= read -r line; do
    # Detect Unreleased section
    if echo "$line" | grep -q "## Unreleased"; then
        IN_UNRELEASED=true
        echo "$line" >> "$TEMP_FILE"
        continue
    fi
    
    # If we hit another release section, we're done
    if [ "$IN_UNRELEASED" = true ] && echo "$line" | grep -qE "^## [0-9]"; then
        # Add entry before this section if we haven't added it yet
        if [ "$ADDED" = false ]; then
            # Add category section if it doesn't exist
            if ! grep -q "^### $CATEGORY" "$TEMP_FILE"; then
                echo "" >> "$TEMP_FILE"
                echo "### $CATEGORY" >> "$TEMP_FILE"
            fi
            echo "- $DESCRIPTION" >> "$TEMP_FILE"
            ADDED=true
        fi
        IN_UNRELEASED=false
    fi
    
    # Check if we're in the category section
    if [ "$IN_UNRELEASED" = true ] && echo "$line" | grep -q "^### $CATEGORY"; then
        CATEGORY_SECTION=true
        echo "$line" >> "$TEMP_FILE"
        continue
    fi
    
    # If we hit another category, we need to insert our entry before it
    if [ "$IN_UNRELEASED" = true ] && [ "$CATEGORY_SECTION" = false ] && echo "$line" | grep -qE "^### (Added|Changed|Fixed|Breaking)"; then
        # Create category section and add entry
        echo "" >> "$TEMP_FILE"
        echo "### $CATEGORY" >> "$TEMP_FILE"
        echo "- $DESCRIPTION" >> "$TEMP_FILE"
        CATEGORY_SECTION=true
        ADDED=true
        echo "$line" >> "$TEMP_FILE"
        continue
    fi
    
    # If we're in the category section and hit the next category or empty line before it
    if [ "$IN_UNRELEASED" = true ] && [ "$CATEGORY_SECTION" = true ] && echo "$line" | grep -qE "^(### |$)"; then
        if echo "$line" | grep -qE "^### "; then
            # Add entry before next category
            if [[ "$OSTYPE" == "darwin"* ]]; then
                sed -i '' '$ i\
- '"$DESCRIPTION"'
' "$TEMP_FILE"
            else
                sed -i '$ i\- '"$DESCRIPTION"'
' "$TEMP_FILE"
            fi
            ADDED=true
            CATEGORY_SECTION=false
        fi
    fi
    
    echo "$line" >> "$TEMP_FILE"
    
done < "$CHANGELOG"

# If we're still in Unreleased and haven't added the entry, add it at the end
if [ "$IN_UNRELEASED" = true ] && [ "$ADDED" = false ]; then
    # Check if there's already content in Unreleased
    if ! tail -n 5 "$TEMP_FILE" | grep -qE "^### "; then
        echo "" >> "$TEMP_FILE"
    fi
    # Check if category section exists
    if ! grep -q "^### $CATEGORY" "$TEMP_FILE"; then
        echo "### $CATEGORY" >> "$TEMP_FILE"
    fi
    # Add entry
    echo "- $DESCRIPTION" >> "$TEMP_FILE"
fi

# Replace changelog
mv "$TEMP_FILE" "$CHANGELOG"

success "Added to CHANGELOG.md:"
info "  [$CATEGORY] $DESCRIPTION"
